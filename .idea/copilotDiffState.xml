<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="CopilotDiffPersistence">
    <option name="pendingDiffs">
      <map>
        <entry key="$PROJECT_DIR$/INSTRUCCIONES_KEY.txt">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/INSTRUCCIONES_KEY.txt" />
              <option name="updatedContent" value="╔═══════════════════════════════════════════════════════════════╗&#10;║            OBTENER SERVICE_ROLE KEY CORRECTA               ║&#10;╚═══════════════════════════════════════════════════════════════╝&#10;&#10;PROBLEMA DETECTADO:&#10;La SERVICE_KEY que proporcionaste tiene un error en su estructura.&#10;Decodificando el JWT se ve: &quot;rose&quot;:&quot;service_role&quot; (incorrecto)&#10;Debería decir: &quot;role&quot;:&quot;service_role&quot;&#10;&#10;SOLUCIÓN:&#10;&#10;1. Abre este link en tu navegador:&#10;   https://supabase.com/dashboard/project/iwukmgzlbocbrsaaoptn/settings/api&#10;&#10;2. En la página que se abre, busca la sección:&#10;   &quot;Project API keys&quot;&#10;&#10;3. Verás DOS keys:&#10;   &#10;   ┌─────────────────────────────────────────────┐&#10;   │ anon                                        │&#10;   │ public                                      │  ← NO ESTA&#10;   │ eyJhbG... [Reveal]                          │&#10;   └─────────────────────────────────────────────┘&#10;   &#10;   ┌─────────────────────────────────────────────┐&#10;   │ service_role                                │&#10;   │ secret                                      │  ← ESTA NECESITAMOS&#10;   │ ••••••••••••••••                [Reveal]    │&#10;   └─────────────────────────────────────────────┘&#10;&#10;4. Click en el botón &quot;Reveal&quot; o &quot;Copy&quot; de la key &quot;service_role&quot;&#10;&#10;5. COPIA toda la key (es MUY larga, empieza con eyJhbGciOi...)&#10;&#10;6. Pégala aquí y yo la actualizaré en el .env&#10;&#10;⚠️ IMPORTANTE:&#10;- Debe ser la key &quot;service_role&quot; (no la &quot;anon&quot;)&#10;- Cópiala COMPLETA desde el primer carácter hasta el último&#10;- No agregues espacios ni saltos de línea&#10;&#10;═══════════════════════════════════════════════════════════════&#10;&#10;Una vez que me des la key correcta, ejecutaré la migración&#10;automáticamente.&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/scripts/check-sqlite-schema.js">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/scripts/check-sqlite-schema.js" />
              <option name="updatedContent" value="// scripts/check-sqlite-schema.js&#10;const Database = require('better-sqlite3');&#10;const path = require('path');&#10;&#10;const db = new Database(path.join(__dirname, '..', 'skateboard.db'), { readonly: true });&#10;&#10;console.log(' Tablas en skateboard.db:\n');&#10;&#10;const tables = db.prepare(&quot;SELECT name FROM sqlite_master WHERE type='table'&quot;).all();&#10;tables.forEach(table =&gt; {&#10;    console.log(`\n Tabla: ${table.name}`);&#10;    const info = db.prepare(`PRAGMA table_info(${table.name})`).all();&#10;    info.forEach(col =&gt; {&#10;        console.log(`   - ${col.name} (${col.type})`);&#10;    });&#10;    &#10;    const count = db.prepare(`SELECT COUNT(*) as count FROM ${table.name}`).get();&#10;    console.log(`   Registros: ${count.count}`);&#10;});&#10;&#10;db.close();&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/scripts/migrate-all-complete.js">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/scripts/migrate-all-complete.js" />
              <option name="updatedContent" value="// scripts/migrate-all-complete.js&#10;// Migración completa usando el servidor como proxy para auth&#10;// Ejecutar: node scripts/migrate-all-complete.js&#10;&#10;require('dotenv').config();&#10;const { createClient } = require('@supabase/supabase-js');&#10;const Database = require('better-sqlite3');&#10;const path = require('path');&#10;const fs = require('fs');&#10;&#10;const SUPABASE_URL = process.env.SUPABASE_URL;&#10;const SUPABASE_ANON_KEY = process.env.SUPABASE_ANON_KEY;&#10;&#10;if (!SUPABASE_URL || !SUPABASE_ANON_KEY) {&#10;    console.error('❌ Faltan credenciales en .env');&#10;    process.exit(1);&#10;}&#10;&#10;const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);&#10;&#10;const dbPath = path.join(__dirname, '..', 'skateboard.db');&#10;if (!fs.existsSync(dbPath)) {&#10;    console.error('❌ No se encontró skateboard.db');&#10;    process.exit(1);&#10;}&#10;&#10;const db = new Database(dbPath, { readonly: true });&#10;&#10;// Mapeo de IDs viejos a nuevos UUIDs&#10;const userIdMap = new Map();&#10;const productIdMap = new Map();&#10;&#10;async function migrateUsers() {&#10;    console.log('\n Migrando usuarios...');&#10;    &#10;    let customers;&#10;    try {&#10;        customers = db.prepare('SELECT * FROM customers').all();&#10;    } catch (error) {&#10;        console.error('❌ Error leyendo customers:', error.message);&#10;        return;&#10;    }&#10;&#10;    console.log(`   Encontrados ${customers.length} usuarios`);&#10;&#10;    for (const customer of customers) {&#10;        try {&#10;            // Registrar usuario usando el endpoint de registro&#10;            const response = await fetch('http://localhost:3000/api/auth/register', {&#10;                method: 'POST',&#10;                headers: { 'Content-Type': 'application/json' },&#10;                body: JSON.stringify({&#10;                    fullname: customer.fullname,&#10;                    username: customer.username,&#10;                    email: customer.email,&#10;                    password: `TempPass123!${customer.id}` // Contraseña temporal&#10;                })&#10;            });&#10;&#10;            const result = await response.json();&#10;&#10;            if (result.success) {&#10;                userIdMap.set(customer.id, result.user.id);&#10;                console.log(`   ✅ ${customer.email} (${customer.role})`);&#10;            } else {&#10;                if (result.message &amp;&amp; result.message.includes('already')) {&#10;                    console.log(`   ⚠️  Ya existe: ${customer.email}`);&#10;                    // Intentar obtener el ID del usuario existente&#10;                    const { data } = await supabase.auth.signInWithPassword({&#10;                        email: customer.email,&#10;                        password: `TempPass123!${customer.id}`&#10;                    });&#10;                    if (data?.user) {&#10;                        userIdMap.set(customer.id, data.user.id);&#10;                    }&#10;                } else {&#10;                    console.error(`   ❌ ${customer.email}: ${result.message}`);&#10;                }&#10;            }&#10;&#10;            await new Promise(resolve =&gt; setTimeout(resolve, 200));&#10;&#10;        } catch (e) {&#10;            console.error(`   ❌ Error en ${customer.email}:`, e.message);&#10;        }&#10;    }&#10;&#10;    console.log(`\n   Usuarios mapeados: ${userIdMap.size}`);&#10;}&#10;&#10;async function migrateProducts() {&#10;    console.log('\n Migrando productos...');&#10;    &#10;    let products;&#10;    try {&#10;        products = db.prepare('SELECT * FROM products').all();&#10;    } catch (error) {&#10;        console.error('❌ Error leyendo products:', error.message);&#10;        return;&#10;    }&#10;&#10;    console.log(`   Encontrados ${products.length} productos`);&#10;&#10;    for (const product of products) {&#10;        try {&#10;            let imagen_url = null;&#10;&#10;            if (product.imagen_url) {&#10;                const imagePath = path.join(__dirname, '..', product.imagen_url);&#10;                &#10;                if (fs.existsSync(imagePath)) {&#10;                    try {&#10;                        const fileBuffer = fs.readFileSync(imagePath);&#10;                        const fileName = path.basename(product.imagen_url);&#10;                        const storagePath = `products/${Date.now()}_${fileName}`;&#10;&#10;                        const { error: uploadError } = await supabase.storage&#10;                            .from('product-images')&#10;                            .upload(storagePath, fileBuffer, {&#10;                                contentType: getContentType(fileName),&#10;                                cacheControl: '3600',&#10;                                upsert: false&#10;                            });&#10;&#10;                        if (!uploadError) {&#10;                            const { data: urlData } = supabase.storage&#10;                                .from('product-images')&#10;                                .getPublicUrl(storagePath);&#10;                            imagen_url = urlData.publicUrl;&#10;                        }&#10;                    } catch (err) {&#10;                        console.warn(`   ⚠️  Error imagen: ${err.message}`);&#10;                    }&#10;                }&#10;            }&#10;&#10;            const { data, error } = await supabase&#10;                .from('products')&#10;                .insert({&#10;                    titulo: product.titulo,&#10;                    detalle: product.detalle,&#10;                    cantidad: product.cantidad || 0,&#10;                    precio: parseFloat(product.precio) || 0,&#10;                    imagen_url: imagen_url&#10;                })&#10;                .select()&#10;                .single();&#10;&#10;            if (!error &amp;&amp; data) {&#10;                productIdMap.set(product.id, data.id);&#10;                console.log(`   ✅ ${product.titulo}`);&#10;            } else if (error) {&#10;                if (error.code === '23505') {&#10;                    console.log(`   ⚠️  Ya existe: ${product.titulo}`);&#10;                    // Intentar obtener el producto existente&#10;                    const { data: existing } = await supabase&#10;                        .from('products')&#10;                        .select('id')&#10;                        .eq('titulo', product.titulo)&#10;                        .single();&#10;                    if (existing) {&#10;                        productIdMap.set(product.id, existing.id);&#10;                    }&#10;                } else {&#10;                    console.error(`   ❌ ${product.titulo}: ${error.message}`);&#10;                }&#10;            }&#10;&#10;            await new Promise(resolve =&gt; setTimeout(resolve, 100));&#10;&#10;        } catch (e) {&#10;            console.error(`   ❌ Error:`, e.message);&#10;        }&#10;    }&#10;&#10;    console.log(`\n   Productos mapeados: ${productIdMap.size}`);&#10;}&#10;&#10;async function migrateCarts() {&#10;    console.log('\n Migrando carritos...');&#10;    &#10;    if (userIdMap.size === 0 || productIdMap.size === 0) {&#10;        console.log('   ⚠️  Saltando - se requieren usuarios y productos migrados');&#10;        return;&#10;    }&#10;&#10;    let cartItems;&#10;    try {&#10;        cartItems = db.prepare(`&#10;            SELECT c.*, cu.email, p.titulo&#10;            FROM cart c&#10;            JOIN customers cu ON c.customer_id = cu.id&#10;            JOIN products p ON c.product_id = p.id&#10;        `).all();&#10;    } catch (error) {&#10;        console.error('❌ Error leyendo cart:', error.message);&#10;        return;&#10;    }&#10;&#10;    console.log(`   Encontrados ${cartItems.length} items`);&#10;&#10;    for (const item of cartItems) {&#10;        try {&#10;            const newUserId = userIdMap.get(item.customer_id);&#10;            const newProductId = productIdMap.get(item.product_id);&#10;&#10;            if (!newUserId) {&#10;                console.log(`   ⚠️  Usuario no encontrado: ${item.email}`);&#10;                continue;&#10;            }&#10;&#10;            if (!newProductId) {&#10;                console.log(`   ⚠️  Producto no encontrado: ${item.titulo}`);&#10;                continue;&#10;            }&#10;&#10;            const { error } = await supabase&#10;                .from('cart')&#10;                .insert({&#10;                    user_id: newUserId,&#10;                    product_id: newProductId,&#10;                    quantity: item.quantity || 1&#10;                });&#10;&#10;            if (error) {&#10;                if (error.code === '23505') {&#10;                    console.log(`   ⚠️  Ya existe: ${item.email} - ${item.titulo}`);&#10;                } else {&#10;                    console.error(`   ❌ Error: ${error.message}`);&#10;                }&#10;            } else {&#10;                console.log(`   ✅ ${item.email} - ${item.titulo} (x${item.quantity})`);&#10;            }&#10;&#10;            await new Promise(resolve =&gt; setTimeout(resolve, 100));&#10;&#10;        } catch (e) {&#10;            console.error(`   ❌ Error:`, e.message);&#10;        }&#10;    }&#10;}&#10;&#10;function getContentType(filename) {&#10;    const ext = path.extname(filename).toLowerCase();&#10;    const types = {&#10;        '.jpg': 'image/jpeg',&#10;        '.jpeg': 'image/jpeg',&#10;        '.png': 'image/png',&#10;        '.webp': 'image/webp',&#10;        '.gif': 'image/gif'&#10;    };&#10;    return types[ext] || 'application/octet-stream';&#10;}&#10;&#10;async function checkServerRunning() {&#10;    try {&#10;        const response = await fetch('http://localhost:3000/api/products');&#10;        return response.ok;&#10;    } catch (e) {&#10;        return false;&#10;    }&#10;}&#10;&#10;async function main() {&#10;    console.log('╔════════════════════════════════════════╗');&#10;    console.log('║   Migración COMPLETA a Supabase     ║');&#10;    console.log('╚════════════════════════════════════════╝');&#10;&#10;    // Verificar que el servidor esté corriendo&#10;    const serverRunning = await checkServerRunning();&#10;    if (!serverRunning) {&#10;        console.error('\n❌ El servidor debe estar corriendo en http://localhost:3000');&#10;        console.error('   Ejecuta en otra terminal: npm start');&#10;        console.error('   Luego ejecuta este script nuevamente\n');&#10;        process.exit(1);&#10;    }&#10;&#10;    console.log('✅ Servidor detectado');&#10;&#10;    try {&#10;        await migrateUsers();&#10;        await migrateProducts();&#10;        await migrateCarts();&#10;&#10;        console.log('\n╔════════════════════════════════════════╗');&#10;        console.log('║  ✨ Migración COMPLETA                ║');&#10;        console.log('╚════════════════════════════════════════╝');&#10;        console.log('\n Resumen:');&#10;        console.log(`   - Usuarios migrados: ${userIdMap.size}`);&#10;        console.log(`   - Productos migrados: ${productIdMap.size}`);&#10;        console.log(`\n⚠️  IMPORTANTE:`);&#10;        console.log(`   - Contraseña temporal para usuarios: TempPass123!{id_antiguo}`);&#10;        console.log(`   - Los usuarios deben cambiar sus contraseñas`);&#10;        console.log(`   - Reactiva RLS ejecutando: scripts/enable-rls-after-migration.sql\n`);&#10;&#10;        db.close();&#10;        process.exit(0);&#10;&#10;    } catch (error) {&#10;        console.error('\n❌ Error fatal:', error);&#10;        db.close();&#10;        process.exit(1);&#10;    }&#10;}&#10;&#10;main();&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/scripts/migrate-simple.js">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/scripts/migrate-simple.js" />
              <option name="originalContent" value="&#10;" />
              <option name="updatedContent" value="// scripts/migrate-simple.js&#10;// Migración COMPLETA usando la estructura real de SQLite&#10;// Ejecutar: node scripts/migrate-simple.js&#10;&#10;require('dotenv').config();&#10;const { createClient } = require('@supabase/supabase-js');&#10;const Database = require('better-sqlite3');&#10;const path = require('path');&#10;const fs = require('fs');&#10;&#10;const SUPABASE_URL = process.env.SUPABASE_URL;&#10;const SUPABASE_ANON_KEY = process.env.SUPABASE_ANON_KEY;&#10;&#10;const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);&#10;const db = new Database(path.join(__dirname, '..', 'skateboard.db'), { readonly: true });&#10;&#10;const userIdMap = new Map();&#10;const productIdMap = new Map();&#10;&#10;async function migrateEverything() {&#10;    console.log('╔════════════════════════════════════════╗');&#10;    console.log('║   Migración COMPLETA a Supabase     ║');&#10;    console.log('╚════════════════════════════════════════╝\n');&#10;&#10;    // 1. Migrar PRODUCTOS&#10;    console.log(' Migrando PRODUCTOS...');&#10;    const products = db.prepare('SELECT * FROM products').all();&#10;    console.log(`   Encontrados: ${products.length}\n`);&#10;&#10;    for (const product of products) {&#10;        try {&#10;            let imagen_url = null;&#10;&#10;            if (product.imagen &amp;&amp; fs.existsSync(path.join(__dirname, '..', product.imagen))) {&#10;                const fileBuffer = fs.readFileSync(path.join(__dirname, '..', product.imagen));&#10;                const fileName = path.basename(product.imagen);&#10;                const storagePath = `products/${Date.now()}_${fileName}`;&#10;&#10;                const { error: uploadError } = await supabase.storage&#10;                    .from('product-images')&#10;                    .upload(storagePath, fileBuffer, {&#10;                        contentType: getContentType(fileName),&#10;                        cacheControl: '3600',&#10;                        upsert: false&#10;                    });&#10;&#10;                if (!uploadError) {&#10;                    const { data: urlData } = supabase.storage&#10;                        .from('product-images')&#10;                        .getPublicUrl(storagePath);&#10;                    imagen_url = urlData.publicUrl;&#10;                    console.log(`    Imagen subida: ${fileName}`);&#10;                }&#10;            }&#10;&#10;            const { data, error } = await supabase.from('products').insert({&#10;                titulo: product.titulo,&#10;                detalle: product.detalle,&#10;                cantidad: product.cantidad || 0,&#10;                precio: parseFloat(product.precio) || 0,&#10;                imagen_url: imagen_url || product.imagen&#10;            }).select().single();&#10;&#10;            if (!error &amp;&amp; data) {&#10;                productIdMap.set(product.id, data.id);&#10;                console.log(`   ✅ ${product.titulo} (${product.precio}€)`);&#10;            } else if (error?.code === '23505') {&#10;                console.log(`   ⚠️  Ya existe: ${product.titulo}`);&#10;                const { data: existing } = await supabase.from('products')&#10;                    .select('id').eq('titulo', product.titulo).single();&#10;                if (existing) productIdMap.set(product.id, existing.id);&#10;            } else {&#10;                console.log(`   ❌ Error: ${product.titulo} - ${error?.message || 'Error desconocido'}`);&#10;            }&#10;&#10;            await new Promise(r =&gt; setTimeout(r, 150));&#10;        } catch (e) {&#10;            console.log(`   ❌ ${e.message}`);&#10;        }&#10;    }&#10;&#10;    // 2. Información sobre USUARIOS&#10;    console.log('\n Información sobre USUARIOS...');&#10;    const users = db.prepare('SELECT * FROM users').all();&#10;    console.log(`   Encontrados: ${users.length}\n`);&#10;    &#10;    console.log(' Lista de usuarios (deben registrarse nuevamente):');&#10;    users.forEach(u =&gt; {&#10;        console.log(`   • ${u.email}`);&#10;        console.log(`     - Nombre: ${u.fullname || u.username}`);&#10;        console.log(`     - Rol: ${u.role || 'comprador'}`);&#10;    });&#10;&#10;    console.log('\n⚠️  IMPORTANTE: Los usuarios NO se migraron porque:');&#10;    console.log('   - Las contraseñas están hasheadas (bcrypt)');&#10;    console.log('   - Supabase Auth no puede importar hashes de bcrypt');&#10;    console.log('   - Necesitan crear cuentas nuevas en la aplicación\n');&#10;&#10;    // 3. Información sobre CARRITOS&#10;    console.log(' Información sobre CARRITOS...');&#10;    const carts = db.prepare(`&#10;        SELECT c.*, u.email, u.username, p.titulo&#10;        FROM cart c&#10;        JOIN users u ON c.user_id = u.id&#10;        JOIN products p ON c.product_id = p.id&#10;    `).all();&#10;    console.log(`   Items encontrados: ${carts.length}\n`);&#10;&#10;    if (carts.length &gt; 0) {&#10;        console.log(' Items en carritos (se perderán):');&#10;        carts.forEach(item =&gt; {&#10;            console.log(`   • ${item.email}: ${item.titulo} (x${item.quantity})`);&#10;        });&#10;        console.log('\n   Los usuarios deben agregar productos nuevamente al carrito\n');&#10;    }&#10;&#10;    console.log('╔════════════════════════════════════════╗');&#10;    console.log('║  ✨ Migración COMPLETADA              ║');&#10;    console.log('╚════════════════════════════════════════╝\n');&#10;&#10;    console.log(' RESUMEN:');&#10;    console.log(`   ✅ Productos migrados: ${productIdMap.size}/${products.length}`);&#10;    console.log(`   ⚠️  Usuarios: ${users.length} (deben registrarse de nuevo)`);&#10;    console.log(`   ⚠️  Carritos: ${carts.length} (se recrearán al comprar)\n`);&#10;&#10;    console.log(' PRÓXIMOS PASOS:');&#10;    console.log('   1. Reactiva RLS en Supabase SQL Editor:');&#10;    console.log('      ALTER TABLE public.products ENABLE ROW LEVEL SECURITY;');&#10;    console.log('      ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;');&#10;    console.log('      ALTER TABLE public.cart ENABLE ROW LEVEL SECURITY;\n');&#10;    console.log('   2. Los usuarios deben registrarse en: http://localhost:3000');&#10;    console.log('   3. Si necesitas un admin, regístrate y actualiza tu rol en Supabase\n');&#10;&#10;    db.close();&#10;}&#10;&#10;function getContentType(filename) {&#10;    const ext = path.extname(filename).toLowerCase();&#10;    return {&#10;        '.jpg': 'image/jpeg',&#10;        '.jpeg': 'image/jpeg',&#10;        '.png': 'image/png',&#10;        '.webp': 'image/webp',&#10;        '.gif': 'image/gif'&#10;    }[ext] || 'application/octet-stream';&#10;}&#10;&#10;migrateEverything().catch(err =&gt; {&#10;    console.error('❌ Error fatal:', err.message);&#10;    db.close();&#10;    process.exit(1);&#10;});" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/scripts/migrate-users-only.js">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/scripts/migrate-users-only.js" />
              <option name="updatedContent" value="// scripts/migrate-users-only.js&#10;// Migra SOLO usuarios de SQLite a Supabase Auth&#10;// Ejecutar: node scripts/migrate-users-only.js&#10;&#10;require('dotenv').config();&#10;const { createClient } = require('@supabase/supabase-js');&#10;const Database = require('better-sqlite3');&#10;const path = require('path');&#10;&#10;const SUPABASE_URL = process.env.SUPABASE_URL;&#10;const SUPABASE_SERVICE_KEY = process.env.SUPABASE_SERVICE_KEY;&#10;&#10;if (!SUPABASE_URL || !SUPABASE_SERVICE_KEY) {&#10;    console.error('❌ Faltan credenciales en .env');&#10;    process.exit(1);&#10;}&#10;&#10;// Crear cliente admin con SERVICE_KEY&#10;const supabaseAdmin = createClient(SUPABASE_URL, SUPABASE_SERVICE_KEY, {&#10;    auth: {&#10;        autoRefreshToken: false,&#10;        persistSession: false&#10;    }&#10;});&#10;&#10;const db = new Database(path.join(__dirname, '..', 'skateboard.db'), { readonly: true });&#10;&#10;async function migrateUsers() {&#10;    console.log('╔════════════════════════════════════════╗');&#10;    console.log('║   Migración de USUARIOS             ║');&#10;    console.log('╚════════════════════════════════════════╝\n');&#10;&#10;    // Leer usuarios de SQLite&#10;    const users = db.prepare('SELECT * FROM users ORDER BY id').all();&#10;    console.log(` Encontrados: ${users.length} usuarios\n`);&#10;&#10;    let migrated = 0;&#10;    let skipped = 0;&#10;    let errors = 0;&#10;&#10;    for (const user of users) {&#10;        try {&#10;            // Generar contraseña temporal segura&#10;            const tempPassword = `Temp${user.id}!${Date.now().toString().slice(-4)}`;&#10;&#10;            console.log(`\n Procesando: ${user.email}`);&#10;            console.log(`   - Nombre: ${user.fullname || user.username}`);&#10;            console.log(`   - Rol: ${user.role || 'comprador'}`);&#10;            console.log(`   - Contraseña temporal: ${tempPassword}`);&#10;&#10;            // Crear usuario en Supabase Auth&#10;            const { data, error } = await supabaseAdmin.auth.admin.createUser({&#10;                email: user.email,&#10;                password: tempPassword,&#10;                email_confirm: true, // Auto-confirmar email&#10;                user_metadata: {&#10;                    fullname: user.fullname || user.username,&#10;                    username: user.username,&#10;                    role: user.role || 'comprador'&#10;                }&#10;            });&#10;&#10;            if (error) {&#10;                if (error.message.includes('already') || error.message.includes('User already registered')) {&#10;                    console.log(`   ⚠️  Ya existe - Saltando`);&#10;                    skipped++;&#10;                } else {&#10;                    console.log(`   ❌ Error: ${error.message}`);&#10;                    errors++;&#10;                }&#10;            } else {&#10;                console.log(`   ✅ Creado exitosamente`);&#10;                console.log(`    UUID: ${data.user.id}`);&#10;                migrated++;&#10;&#10;                // Esperar un poco para que el trigger de profiles se ejecute&#10;                await new Promise(resolve =&gt; setTimeout(resolve, 300));&#10;            }&#10;&#10;        } catch (e) {&#10;            console.log(`   ❌ Excepción: ${e.message}`);&#10;            errors++;&#10;        }&#10;    }&#10;&#10;    console.log('\n╔════════════════════════════════════════╗');&#10;    console.log('║  ✨ Migración COMPLETADA              ║');&#10;    console.log('╚════════════════════════════════════════╝\n');&#10;&#10;    console.log(' RESUMEN:');&#10;    console.log(`   ✅ Migrados: ${migrated}`);&#10;    console.log(`   ⚠️  Saltados (ya existían): ${skipped}`);&#10;    console.log(`   ❌ Errores: ${errors}`);&#10;    console.log(`    Total procesados: ${users.length}\n`);&#10;&#10;    if (migrated &gt; 0) {&#10;        console.log(' CONTRASEÑAS TEMPORALES:');&#10;        console.log('   Formato: Temp{id}!{últimos4dígitosFecha}');&#10;        console.log('   Ejemplo: Temp1!2025, Temp2!2025, etc.\n');&#10;        &#10;        console.log(' LISTA DE USUARIOS MIGRADOS:');&#10;        const usersList = db.prepare('SELECT id, email, fullname, username, role FROM users ORDER BY id').all();&#10;        usersList.forEach(u =&gt; {&#10;            const tempPass = `Temp${u.id}!${Date.now().toString().slice(-4)}`;&#10;            console.log(`\n   ${u.email}`);&#10;            console.log(`   - ID antiguo: ${u.id}`);&#10;            console.log(`   - Contraseña: ${tempPass}`);&#10;            console.log(`   - Rol: ${u.role || 'comprador'}`);&#10;        });&#10;    }&#10;&#10;    console.log('\n⚠️  IMPORTANTE:');&#10;    console.log('   1. Los usuarios deben cambiar sus contraseñas al iniciar sesión');&#10;    console.log('   2. Envía a cada usuario su email y contraseña temporal');&#10;    console.log('   3. Si necesitas actualizar roles manualmente:');&#10;    console.log('      - Ve a Supabase Dashboard &gt; Table Editor &gt; profiles');&#10;    console.log('      - Edita el campo &quot;role&quot; (comprador o admin)\n');&#10;&#10;    db.close();&#10;}&#10;&#10;// Verificar que la SERVICE_KEY sea válida antes de migrar&#10;async function checkServiceKey() {&#10;    try {&#10;        const { data, error } = await supabaseAdmin.auth.admin.listUsers({ page: 1, perPage: 1 });&#10;        if (error) {&#10;            console.error('❌ SERVICE_KEY inválida:', error.message);&#10;            console.error('\n SOLUCIÓN:');&#10;            console.error('   1. Ve a Supabase Dashboard &gt; Settings &gt; API');&#10;            console.error('   2. Copia la &quot;service_role&quot; key (NO la &quot;anon&quot; key)');&#10;            console.error('   3. Actualiza SUPABASE_SERVICE_KEY en .env\n');&#10;            return false;&#10;        }&#10;        return true;&#10;    } catch (e) {&#10;        console.error('❌ Error conectando a Supabase:', e.message);&#10;        return false;&#10;    }&#10;}&#10;&#10;async function main() {&#10;    const isValid = await checkServiceKey();&#10;    if (!isValid) {&#10;        process.exit(1);&#10;    }&#10;&#10;    await migrateUsers();&#10;    process.exit(0);&#10;}&#10;&#10;main();&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/scripts/verify-jwt.js">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/scripts/verify-jwt.js" />
              <option name="updatedContent" value="// scripts/verify-jwt.js&#10;// Verificar el contenido del JWT&#10;&#10;require('dotenv').config();&#10;&#10;const jwt = process.env.SUPABASE_SERVICE_KEY;&#10;&#10;console.log(' Analizando JWT...\n');&#10;console.log('JWT completo:', jwt);&#10;console.log('\nLongitud:', jwt ? jwt.length : 0, 'caracteres\n');&#10;&#10;if (jwt) {&#10;    try {&#10;        // Decodificar el JWT manualmente (solo para inspección, no para validación)&#10;        const parts = jwt.split('.');&#10;        if (parts.length === 3) {&#10;            const header = JSON.parse(Buffer.from(parts[0], 'base64').toString());&#10;            const payload = JSON.parse(Buffer.from(parts[1], 'base64').toString());&#10;            &#10;            console.log(' Header:');&#10;            console.log(JSON.stringify(header, null, 2));&#10;            &#10;            console.log('\n Payload:');&#10;            console.log(JSON.stringify(payload, null, 2));&#10;            &#10;            // Verificar si tiene el campo correcto&#10;            if (payload.role === 'service_role') {&#10;                console.log('\n✅ JWT es VÁLIDO - tiene role: &quot;service_role&quot;');&#10;            } else if (payload.rose === 'service_role') {&#10;                console.log('\n❌ JWT tiene ERROR TIPOGRÁFICO - dice &quot;rose&quot; en lugar de &quot;role&quot;');&#10;                console.log('   Esto NO es válido. Necesitas copiar la key correcta desde Supabase.');&#10;            } else {&#10;                console.log('\n❌ JWT no tiene el campo &quot;role&quot; esperado');&#10;            }&#10;        }&#10;    } catch (e) {&#10;        console.error('❌ Error decodificando JWT:', e.message);&#10;    }&#10;}&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
      </map>
    </option>
  </component>
</project>